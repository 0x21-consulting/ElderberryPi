{
  "variables": {
    "img_mount_path": "/mnt/blueberry",
    "ssh_key_src": "/home/vagrant/.ssh/id_ed25519.pub",
    "image_home_dir": "/home/ubuntu"
  },
  "builders": [{
    "type": "arm-image",
    "qemu_binary": "qemu-aarch64-static",
    "image_type": "raspberrypi",
    "target_image_size": 8589934592,
    "output_filename": "artifacts/base.img",
    "chroot_mounts": [
      ["proc", "proc", "/proc"],
      ["sysfs", "sysfs", "/sys"],
      ["bind", "/dev", "/dev"],
      ["devpts", "devpts", "/dev/pts"],
      ["binfmt_misc", "binfmt_misc", "/proc/sys/fs/binfmt_misc"]
    ],
    "additional_chroot_mounts": [
      ["bind", "/run/systemd", "/run/systemd"]
    ],
    "mount_path": "{{ user `img_mount_path` }}",
    "iso_url": "http://cdimage.ubuntu.com/releases/18.04.4/release/ubuntu-18.04.4-preinstalled-server-arm64+raspi3.img.xz",
    "iso_checksum_type": "sha256",
    "iso_checksum": "f270d4a11fcef7f85ea77bc0642d1c6db2666ae734e9dcc4cb875a31c9f0dc57"
  }],
  "provisioners": [{
    "type": "shell",
    "inline": [
      "echo Setting up SSH auth...",
      "mkdir -p {{user `image_home_dir`}}/.ssh",
      "sed '/PasswordAuthentication/d' -i /etc/ssh/ssh_config",
      "echo  >> /etc/ssh/ssh_config",
      "echo 'PasswordAuthentication no' >> /etc/ssh/ssh_config",

      "echo Installing Ansible...",
      "sudo apt-get update",
      "sudo apt-get install software-properties-common",
      "sudo add-apt-repository --yes --update ppa:ansible/ansible",
      "sudo apt-get install -y ansible"
    ],
    "environment_vars": ["DEBIAN_FRONTEND=noninteractive"]
  }, {
    "type": "file",
    "source": "{{user `ssh_key_src`}}",
    "destination": "{{user `image_home_dir`}}/.ssh/authorized_keys"
  }, {
    "type": "file",
    "source": "ansible",
    "destination": "{{user `image_home_dir`}}"
  }, {
    "type": "shell",
    "inline": [
      "echo Correcting permissions...",
      "chown -R 1000:1000 {{user `image_home_dir`}}"
    ]
  }]
}

